<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papelaria Ideal - Sistema de Gest√£o</title>
    <style>
        * {
            padding: 0;
            box-sizing: border-box;
            margin: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ede5d8;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #DED6C9;
            padding: 0 15px 0 20px;
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .logo-area {
    display: flex;
    align-items: center;
    cursor: pointer;
    gap: 15px;
    margin-left: -10px; /* NOVO: Puxa o conte√∫do de toda a √°rea 10px para a esquerda */
}

        .header-logo-icon {
            height: 130px;
            width: auto;
            object-fit: contain;
            /* REMOVIDO: margin-right: 15px; */
        }
        
        /* NOVO: Classe para sua imagem (titulo.png) */
        .header-logo-icon-custom {
        height: 230px;
        width: auto;
        object-fit: contain;
        margin-left: -80px; /* NOVO: Puxa sua imagem 10px para a esquerda, sobrepondo o gap do .logo-area */
        margin-top: -5px;
}

        .user-info {
            text-align: right;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #logoutBtn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        #logoutBtn:hover {
            background: #c82333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            flex-grow: 1;
        }

        /* NOVO: Container mais largo para telas de autentica√ß√£o */
        .container.container-auth {
            max-width: 1400px;
        }

        .page-title {
            text-align: center;
            color: #142c71;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .page-subtitle {
            text-align: center;
            color: #142c71;
            font-size: 20px;
            margin-bottom: 40px;
        }

        .page-title-custom {
            text-align: center;
            color: #6D4C41;
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 30px;
            font-family: Montserrat;
        }
        
        .content-painel {
            padding: 100px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        .nav-btn {
            background: #142c71;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(20, 44, 113, 0.2);
        }

        .nav-btn:hover {
            background: #0d1f4d;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(20, 44, 113, 0.3);
        }

        .nav-btn.active {
            background: #0a1538;
        }

        .info-text {
            text-align: center;
            color: #142c71;
            font-size: 16px;
            margin-top: 30px;
        }

        .content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .content.active {
            display: block;
        }

        .content-title {
            display: none;
        }
        
        .content-title.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #ddd;
            max-width: 1200px;
            
        }

        .card h3 {
            color: #142c71;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #142c71;
            padding-bottom: 10px;
        }

        /* NOVO CSS: EMOJI MAIOR */
        .large-emoji {
            font-size: 1.5em; 
            margin-right: 5px; 
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #142c71;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ede5d8;
            border-radius: 6px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #142c71;
        }
        
        .filtro-container .form-group {
            margin-bottom: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* Formul√°rios de cadastro em 2 colunas */
        #viewCadastro .form-row,
        #viewLogin .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        #formNovaMovimentacao .form-row {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #142c71;
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #0d1f4d;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none !important;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table thead {
            background: #142c71;
            color: white;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table tbody tr:hover {
            background: #ede5d8;
        }

        .stats-grid {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            flex: 1;
            min-width: 300px; /* Garante que n√£o fiquem muito pequenos */
            background: #142c71;
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card {
            background: #142c71;
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
        }

        .user-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .user-type-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #142c71;
            background: white;
            color: #142c71;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .user-type-btn.active {
            background: #142c71;
            color: white;
        }

        .login-link {
            text-align: center;
            margin-top: 20px;
            color: #142c71;
            cursor: pointer;
            text-decoration: underline;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #000;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #142c71;
            font-size: 14px;
            margin-top: 40px;
            background-color: #ded6c9;
        }

        #viewPainelFornecedor {
            background-color: white;
            border: 5px;
            padding: 70px;
            margin-top: 90px;
        }

        #viewPainelFornecedorTitle {
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 20px;
            }

            .user-info {
                text-align: center;
                margin-top: 15px;
                flex-direction: column;
            }

            .nav-buttons {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
            
            #viewCadastro .form-row,
            #viewLogin .form-row {
                grid-template-columns: 1fr;
            }
            
            #formNovaMovimentacao .form-row {
                flex-direction: column;
            }
            
            .container.container-auth {
                max-width: 100%;
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-area" onclick="irParaInicio()">
            <img src="img/logo.png" alt="Logo Papelaria Ideal" class="header-logo-icon">
            <img src="img/titulo.png" alt="Papelaria Ideal" class="header-logo-icon-custom">
        </div>
        <div id="userInfo" class="user-info hidden">
            <span id="welcomeMsg"></span>
            <button id="logoutBtn">Sair</button>
        </div>
    </div>
    
    <div class="container" id="mainContainer">
        <div id="viewCadastro" class="content active">
            <h2 class="page-title">Criar Nova Conta</h2>
            
            <div class="user-type-selector">
                <button class="user-type-btn active" onclick="setCadastroType('cliente')">Cliente</button>
                <button class="user-type-btn" onclick="setCadastroType('fornecedor')">Fornecedor</button>
            </div>

            <div id="alertCadastro" class="alert hidden"></div>

            <form id="formCliente">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo: *</label>
                        <input type="text" id="clienteNome" required>
                    </div>
                    <div class="form-group">
                        <label>CPF: *</label>
                        <input type="text" id="clienteCpf" maxlength="14" placeholder="000.000.000-00" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Telefone: *</label>
                        <input type="tel" id="clienteTelefone" maxlength="15" placeholder="(00) 00000-0000" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Nascimento: *</label>
                        <input type="date" id="clienteDataNasc" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email: *</label>
                        <input type="email" id="clienteEmail" placeholder="seu@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>Senha: * (m√≠nimo 6 caracteres)</label>
                        <input type="password" id="clienteSenha" minlength="6" required>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Cadastrar Cliente</button>
            </form>

            <form id="formFornecedor" class="hidden">
                <div class="form-row">
                    <div class="form-group">
                        <label>Raz√£o Social: *</label>
                        <input type="text" id="fornecedorRazao" required>
                    </div>
                    <div class="form-group">
                        <label>Inscri√ß√£o Estadual: *</label>
                        <input type="text" id="fornecedorIE" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>CNPJ: *</label>
                        <input type="text" id="fornecedorCnpj" maxlength="18" placeholder="00.000.000/0000-00" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone: *</label>
                        <input type="tel" id="fornecedorTelefone" maxlength="15" placeholder="(00) 00000-0000" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome do Respons√°vel: *</label>
                        <input type="text" id="fornecedorResponsavel" required>
                    </div>
                    <div class="form-group">
                        <label>Data de Nascimento (Respons√°vel): *</label>
                        <input type="date" id="fornecedorDataNasc" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>CPF do Respons√°vel: *</label>
                        <input type="text" id="fornecedorCpfResp" maxlength="14" placeholder="000.000.000-00" required>
                    </div>
                    <div class="form-group">
                        <label>Email Corporativo: *</label>
                        <input type="email" id="fornecedorEmail" placeholder="contato@empresa.com" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Senha: * (m√≠nimo 6 caracteres)</label>
                    <input type="password" id="fornecedorSenha" minlength="6" required>
                </div>

                <button type="submit" class="btn btn-primary">Cadastrar Fornecedor</button>
            </form>

            <div class="login-link" onclick="showView('viewLogin')">
                J√° tem uma conta? Fa√ßa login aqui
            </div>
        </div>

        <div id="viewLogin" class="content">
            <h2 class="page-title">Acessar Sistema</h2>

            <div class="user-type-selector">
                <button class="user-type-btn active" onclick="setLoginType('cliente')">Sou Cliente</button>
                <button class="user-type-btn" onclick="setLoginType('fornecedor')">Sou Fornecedor</button>
            </div>

            <div id="alertLogin" class="alert hidden"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>Senha:</label>
                    <input type="password" id="loginSenha" required>
                </div>
                <button type="submit" class="btn btn-primary">Entrar</button>
            </form>

            <div class="login-link" onclick="showView('viewCadastro')">
                N√£o tem uma conta? Cadastre-se aqui
            </div>
        </div>

        <h2 class="page-title-custom content-title" id="viewPainelFornecedorTitle">BEM-VINDO AO PAINEL DO FORNECEDOR</h2>

        <div id="viewPainelFornecedor" class="content content-painel">
            <div class="nav-buttons">
                <button class="nav-btn" onclick="showView('viewProdutos')">Cadastrar Produto</button>
                <button class="nav-btn" onclick="showView('viewGerenciarFornecedores')">Gerenciar Fornecedores</button>
                <button class="nav-btn" onclick="showView('viewEstoque')">Movimenta√ß√£o de Estoque</button>
                <button class="nav-btn" onclick="showView('viewHistorico')">Hist√≥rico</button>
            </div>
            <p class="info-text">Selecione uma das op√ß√µes acima para gerenciar seus produtos e estoque.</p>
        </div>

        <div id="viewMinhasCompras" class="content">
            <h2 class="page-title">Minhas Compras</h2>
            <div class="card">
                <h3>Hist√≥rico de Compras</h3>
                <p>Em breve voc√™ poder√° visualizar todo o hist√≥rico de suas compras aqui.</p>
            </div>
        </div>

        <div id="viewProdutos" class="content">
            <button class="btn btn-info btn-sm" onclick="showView('viewPainelFornecedor')" style="margin-bottom: 20px;">
                &larr; Voltar ao Painel
            </button>

            <div class="card" style="max-width: 1400px; margin: 0 auto;">
                <h3>Cadastrar / Editar Produto</h3>
                <form id="produtoForm">
                    <input type="hidden" id="prodId">
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="prodNome">Nome do Produto:</label>
                            <input type="text" id="prodNome" required>
                        </div>
                        <div class="form-group">
                            <label for="prodMaterial">Material:</label>
                            <input type="text" id="prodMaterial" placeholder="Ex: Papel, Pl√°stico">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="prodDescricao">Descri√ß√£o:</label>
                        <input type="text" id="prodDescricao" placeholder="Descreva o produto...">
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="prodTamanho">Tamanho:</label>
                            <input type="text" id="prodTamanho" placeholder="Ex: A4, 15cm">
                        </div>
                        <div class="form-group">
                            <label for="prodPeso">Peso (kg):</label>
                            <input type="number" step="0.01" id="prodPeso">
                        </div>
                    </div>
                    <input type="hidden" id="prodEstoqueInicial" value="0">
                    <button type="submit" class="btn btn-primary">Salvar Produto</button>
                </form>
            </div>
            <div class="card">
                <h3>Produtos Cadastrados</h3>
                <div class="table-container">
                    <table id="tabelaProdutos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Material</th>
                                <th>Fornecedor</th>
                                <th>Estoque</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="viewEstoque" class="content">
            <button class="btn btn-info btn-sm" onclick="showView('viewPainelFornecedor')" style="margin-bottom: 20px;">
                &larr; Voltar ao Painel
            </button>

            <div class="card">
    <h3><span class="large-emoji">‚úçÔ∏è</span> Registrar Movimenta√ß√£o R√°pida</h3>
    <form id="formNovaMovimentacao">
        <div class="form-row" style="display: grid; grid-template-columns: 3fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="movProduto">Produto:</label>
                <select id="movProduto" required>
                    <option value="">Nenhum produto cadastrado</option>
                </select>
            </div>
            <div class="form-group">
                <label for="movTipo">Tipo:</label>
                <select id="movTipo" required>
                    <option value="entrada">Entrada</option>
                    <option value="saida">Sa√≠da</option>
                </select>
            </div>
        </div>
        
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 3fr; gap: 20px;">
            <div class="form-group">
                <label for="movQuantidade">Quantidade:</label>
                <input type="number" id="movQuantidade" min="1" required>
            </div>
            <div class="form-group">
                <label for="movObservacao">Observa√ß√£o (Opcional):</label>
                <input type="text" id="movObservacao" placeholder="Ex: Compra NF-123, Venda Pedido 456">
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Registrar Movimenta√ß√£o</button>
    </form>
</div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h4><span class="large-emoji">üî¢</span> Total de Produtos</h4>
                    <div class="value" id="totalProdutos">0</div>
                </div>
                <div class="stat-card">
                    <h4><span class="large-emoji">üì•</span> Entradas Hoje</h4>
                    <div class="value" id="entradasHoje">0</div>
                </div>
                <div class="stat-card">
                    <h4><span class="large-emoji">üì§</span> Sa√≠das Hoje</h4>
                    <div class="value" id="saidasHoje">0</div>
                </div>
            </div>

            <div class="card">
                <h3><span class="large-emoji">üìã</span> Posi√ß√£o Atual do Estoque</h3>
                <div class="table-container">
                    <table id="tabelaPosicaoEstoque">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Produto</th>
                                <th>Fornecedor</th>
                                <th>Estoque Atual</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="viewHistorico" class="content">
            <button class="btn btn-info btn-sm" onclick="showView('viewPainelFornecedor')" style="margin-bottom: 20px;">
                &larr; Voltar ao Painel
            </button>

            <h2 class="page-title">Hist√≥rico de Movimenta√ß√µes</h2>
            
            <div class="card filtro-container" style="padding: 20px; background-color: #f8f9fa;">
                <h3 style="margin-bottom: 15px; border-bottom: none;">Filtros de Busca</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-end;">
                    
                    <div class="form-group" style="flex: 2; min-width: 250px;">
                        <label for="filtroProduto">Buscar por Produto:</label>
                        <input type="text" id="filtroProduto" placeholder="Digite o nome do produto...">
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="filtroData">Filtrar por Data:</label>
                        <input type="date" id="filtroData">
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 150px;">
                        <label for="filtroTipo">Filtrar por Tipo:</label>
                        <select id="filtroTipo">
                            <option value="">Todos os Tipos</option>
                            <option value="entrada">Entrada</option>
                            <option value="saida">Sa√≠da</option>
                        </select>
                    </div>

                    <button class="btn btn-sm btn-danger" onclick="limparFiltrosHistorico()" style="margin-bottom: 0; height: 45px;">
                        Limpar Filtros
                    </button>

                    <button class="btn btn-sm btn-danger" onclick="excluirHistoricoCompleto()" style="margin-bottom: 0; height: 45px; background: #721c24;">
                        üóëÔ∏è Excluir Hist√≥rico
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table id="tabelaHistorico">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Observa√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <p id="semResultadosHistorico" class="info-text hidden" style="margin-top: 20px;">
                        Nenhum registro encontrado com os filtros aplicados.
                    </p>
                </div>
            </div>
        </div>

        <div id="viewGerenciarFornecedores" class="content">
            <button class="btn btn-info btn-sm" onclick="showView('viewPainelFornecedor')" style="margin-bottom: 20px;">
                &larr; Voltar ao Painel
            </button>
            <div class="card">
                <h3>Cadastrar Novo Fornecedor</h3>
                <form id="formNovoFornecedor">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Raz√£o Social: *</label>
                            <input type="text" id="novoFornecedorRazao" required>
                        </div>
                        <div class="form-group">
                            <label>CNPJ: *</label>
                            <input type="text" id="novoFornecedorCnpj" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Inscri√ß√£o Estadual:</label>
                            <input type="text" id="novoFornecedorIE">
                        </div>
                        <div class="form-group">
                            <label>Email Corporativo: *</label>
                            <input type="email" id="novoFornecedorEmail" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Telefone:</label>
                        <input type="tel" id="novoFornecedorTelefone">
                    </div>
                    <button type="submit" class="btn btn-primary">Cadastrar Fornecedor</button>
                </form>
            </div>
            <div class="card">
                <h3>Fornecedores Cadastrados</h3>
                <div class="table-container">
                    <table id="tabelaFornecedoresCadastrados">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Raz√£o Social</th>
                                <th>CNPJ</th>
                                <th>Email</th>
                                <th>Telefone</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div class="footer">
        ¬© Papelaria Ideal - √Årea do Fornecedor
    </div>

    <div id="modalEditarFornecedor" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal('modalEditarFornecedor')">&times;</span>
            <h3>Editar Fornecedor</h3>
            <form id="formEditarFornecedor">
                <input type="hidden" id="editFornecedorId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Raz√£o Social:</label>
                        <input type="text" id="editFornecedorRazao" required>
                    </div>
                    <div class="form-group">
                        <label>CNPJ:</label>
                        <input type="text" id="editFornecedorCnpj" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Inscri√ß√£o Estadual:</label>
                        <input type="text" id="editFornecedorIE">
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="editFornecedorEmail" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Telefone:</label>
                    <input type="tel" id="editFornecedorTelefone">
                </div>
                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>
    
    <div id="modalAjusteEstoque" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="fecharModal('modalAjusteEstoque')">&times;</span>
            <h3>Ajustar Quantidade de Estoque (Invent√°rio)</h3>
            <form id="formAjusteEstoque">
                <input type="hidden" id="ajusteProdutoId">
                <div class="form-group">
                    <label>Produto:</label>
                    <input type="text" id="ajusteProdutoNome" readonly>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Qtd. Atual:</label>
                        <input type="number" id="ajusteQtdAtual" readonly>
                    </div>
                    <div class="form-group">
                        <label>Nova Qtd. (Total):</label>
                        <input type="number" id="ajusteQtdNova" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observa√ß√£o (Obrigat√≥rio para ajuste):</label>
                    <input type="text" id="ajusteObservacao" placeholder="Ex: Contagem de invent√°rio, Perda" required>
                </div>
                <button type="submit" class="btn btn-primary">Salvar Ajuste</button>
            </form>
        </div>
    </div>

    <script>
        const state = {
            loggedInUser: null,
            cadastroType: 'cliente',
            loginType: 'cliente',
            produtos: [],
            fornecedores: [],
            movimentacoes: [] 
        };

        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = localStorage.getItem('loggedInUser');
            if (storedUser) {
                state.loggedInUser = JSON.parse(storedUser);
                updateUIAfterLogin();
            } else {
                showView('viewCadastro');
            }

            carregarDadosIniciaisDoBanco();

            document.getElementById('formCliente').addEventListener('submit', (e) => handleCadastro(e, 'cliente'));
            document.getElementById('formFornecedor').addEventListener('submit', (e) => handleCadastro(e, 'fornecedor'));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('produtoForm').addEventListener('submit', handleSalvarProduto);
            document.getElementById('formNovoFornecedor').addEventListener('submit', handleNovoFornecedor);
            document.getElementById('formEditarFornecedor').addEventListener('submit', handleSalvarEdicaoFornecedor);
            document.getElementById('formAjusteEstoque').addEventListener('submit', handleAjusteEstoque);
            document.getElementById('formNovaMovimentacao').addEventListener('submit', handleNovaMovimentacao);

            document.getElementById('filtroProduto').addEventListener('input', renderizarTabelaHistorico);
            document.getElementById('filtroData').addEventListener('change', renderizarTabelaHistorico);
            document.getElementById('filtroTipo').addEventListener('change', renderizarTabelaHistorico);

            document.getElementById('clienteCpf').addEventListener('input', (e) => e.target.value = mascaraCPF(e.target.value));
            document.getElementById('fornecedorCpfResp').addEventListener('input', (e) => e.target.value = mascaraCPF(e.target.value));
            document.getElementById('fornecedorCnpj').addEventListener('input', (e) => e.target.value = mascaraCNPJ(e.target.value));
            document.getElementById('novoFornecedorCnpj').addEventListener('input', (e) => e.target.value = mascaraCNPJ(e.target.value));
        });

        async function carregarDadosIniciaisDoBanco() {
            if (!state.loggedInUser) return;
            try {
                const respFornecedores = await fetch('fornecedores.php');
                const resFornecedores = await respFornecedores.json();
                if (resFornecedores.success) {
                    state.fornecedores = resFornecedores.data;
                } else {
                    if (resFornecedores.message.includes("Acesso negado")) handleLogout();
                }

                const respProdutos = await fetch('produtos.php');
                const resProdutos = await respProdutos.json();
                if (resProdutos.success) {
                    state.produtos = resProdutos.data;
                } else {
                    if (resProdutos.message.includes("Acesso negado")) handleLogout();
                }

                carregarFornecedores(); 
                
                const activeView = document.querySelector('.content.active');
                if (activeView) {
                    showView(activeView.id); 
                }

            } catch (error) {
                console.error("Erro ao carregar dados iniciais:", error);
                if (!navigator.onLine) {
                    alert("Erro de rede. Verifique sua conex√£o.");
                }
            }
        }
        
        function updateUIAfterLogin() {
            if (!state.loggedInUser) return;
            const user = state.loggedInUser;
            const nome = user.tipo === 'cliente' ? user.nome_completo : user.razao_social;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('welcomeMsg').textContent = `Bem-vindo(a), ${nome}!`;

            if (user.tipo === 'cliente') {
                showView('viewMinhasCompras');
            } else {
                showView('viewPainelFornecedor');
            }
        }

        function showView(viewName) {
            // NOVO: Adiciona classe especial para views de autentica√ß√£o
            const mainContainer = document.getElementById('mainContainer');
            if (viewName === 'viewCadastro' || viewName === 'viewLogin') {
                mainContainer.classList.add('container-auth');
            } else {
                mainContainer.classList.remove('container-auth');
            }
            
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.content-title').forEach(title => title.classList.remove('active'));

            const view = document.getElementById(viewName);
            if(view) view.classList.add('active');

            const title = document.getElementById(viewName + 'Title'); 
            if (title) {
                title.classList.add('active');
            }

            if (state.loggedInUser) {
                if (viewName === 'viewProdutos') carregarProdutos();
                if (viewName === 'viewHistorico') carregarHistorico();
                if (viewName === 'viewGerenciarFornecedores') carregarTabelaFornecedores();
                
                if (viewName === 'viewEstoque') {
                    carregarTabelaPosicaoEstoque();
                    carregarDropdownProdutos();
                }
            }
        }

        function irParaInicio() {
            if (state.loggedInUser) {
                const tipo = state.loggedInUser.tipo;
                if (tipo === 'cliente') {
                    showView('viewMinhasCompras');
                } else if (tipo === 'fornecedor') {
                    showView('viewPainelFornecedor');
                }
            } else {
                showView('viewLogin');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const payload = {
                email: document.getElementById('loginEmail').value,
                senha: document.getElementById('loginSenha').value,
                tipo: state.loginType
            };
            try {
                const response = await fetch('login.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if(result.success) {
                    state.loggedInUser = result.data;
                    localStorage.setItem('loggedInUser', JSON.stringify(result.data));
                    showAlert('alertLogin', result.message, 'success');
                    await carregarDadosIniciaisDoBanco();
                    setTimeout(updateUIAfterLogin, 1000);
                } else {
                    showAlert('alertLogin', result.message, 'error');
                }
            } catch (error) {
                showAlert('alertLogin', 'Erro de comunica√ß√£o com o servidor.', 'error');
            }
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            state.loggedInUser = null;
            fetch('logout.php'); 
            // window.location.reload(); // Removido
            window.location.href = 'index.html'; // NOVO: Redireciona para a tela inicial
        }

        function setCadastroType(type) {
            state.cadastroType = type;
            document.querySelectorAll('#viewCadastro .user-type-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('formCliente').classList.toggle('hidden', type !== 'cliente');
            document.getElementById('formFornecedor').classList.toggle('hidden', type === 'cliente');
        }

        function setLoginType(type) {
            state.loginType = type;
            document.querySelectorAll('#viewLogin .user-type-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        async function handleCadastro(e, tipo) {
            e.preventDefault();
            let payload = { tipo: tipo };

            if (tipo === 'cliente') {
                payload.nome = document.getElementById('clienteNome').value;
                payload.cpf = document.getElementById('clienteCpf').value;
                payload.telefone = document.getElementById('clienteTelefone').value;
                payload.data_nascimento = document.getElementById('clienteDataNasc').value;
                payload.email = document.getElementById('clienteEmail').value;
                payload.senha = document.getElementById('clienteSenha').value;
            } else {
                payload.razao_social = document.getElementById('fornecedorRazao').value;
                payload.inscricao_estadual = document.getElementById('fornecedorIE').value;
                payload.cnpj = document.getElementById('fornecedorCnpj').value;
                payload.nome_responsavel = document.getElementById('fornecedorResponsavel').value;
                payload.data_nascimento_responsavel = document.getElementById('fornecedorDataNasc').value;
                payload.cpf_responsavel = document.getElementById('fornecedorCpfResp').value;
                payload.telefone = document.getElementById('fornecedorTelefone').value;
                payload.email = document.getElementById('fornecedorEmail').value;
                payload.senha = document.getElementById('fornecedorSenha').value;
            }

            try {
                const response = await fetch('cadastro.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                showAlert('alertCadastro', result.message, result.success ? 'success' : 'error');
                
                if(result.success) {
                    e.target.reset();
                    setTimeout(() => showView('viewLogin'), 2000);
                }
            } catch (error) {
                showAlert('alertCadastro', 'Erro de comunica√ß√£o com o servidor.', 'error');
            }
        }

        async function handleNovoFornecedor(e) {
            e.preventDefault();
            const payload = {
                razao_social: document.getElementById('novoFornecedorRazao').value,
                cnpj: document.getElementById('novoFornecedorCnpj').value,
                inscricao_estadual: document.getElementById('novoFornecedorIE').value,
                email_corporativo: document.getElementById('novoFornecedorEmail').value,
                telefone: document.getElementById('novoFornecedorTelefone').value
            };
            
            try {
                const response = await fetch('fornecedores.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                alert(result.message); 

                if (result.success) {
                    e.target.reset();
                    await carregarDadosIniciaisDoBanco(); 
                }
            } catch (error) {
                alert('Erro de comunica√ß√£o ao cadastrar novo fornecedor.');
            }
        }

        function carregarFornecedores() {
            const select = document.getElementById('prodFornecedor');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione...</option>';
            state.fornecedores.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.razao_social;
                select.appendChild(option);
            });
            
            if(state.fornecedores.length > 0) {
                select.value = state.fornecedores[0].id;
            }
        }

        function carregarTabelaFornecedores() {
            const tbody = document.querySelector('#tabelaFornecedoresCadastrados tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            state.fornecedores.forEach(f => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.id}</td>
                    <td>${f.razao_social || '-'}</td>
                    <td>${f.cnpj || '-'}</td>
                    <td>${f.email_corporativo || '-'}</td>
                    <td>${f.telefone || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="abrirModalEditarFornecedor(${f.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirFornecedor(${f.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function abrirModalEditarFornecedor(id) {
            const fornecedor = state.fornecedores.find(f => f.id == id);
            if(fornecedor) {
                document.getElementById('editFornecedorId').value = fornecedor.id;
                document.getElementById('editFornecedorRazao').value = fornecedor.razao_social;
                document.getElementById('editFornecedorCnpj').value = fornecedor.cnpj;
                document.getElementById('editFornecedorIE').value = fornecedor.inscricao_estadual;
                document.getElementById('editFornecedorEmail').value = fornecedor.email_corporativo;
                document.getElementById('editFornecedorTelefone').value = fornecedor.telefone;
                document.getElementById('modalEditarFornecedor').style.display = 'flex';
            }
        }

        async function handleSalvarEdicaoFornecedor(e) {
            e.preventDefault();
            const payload = {
                id: document.getElementById('editFornecedorId').value,
                razao_social: document.getElementById('editFornecedorRazao').value,
                inscricao_estadual: document.getElementById('editFornecedorIE').value,
                email_corporativo: document.getElementById('editFornecedorEmail').value,
                telefone: document.getElementById('editFornecedorTelefone').value
            };

            try {
                const response = await fetch('fornecedores.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if(result.success) {
                    alert(result.message);
                    fecharModal('modalEditarFornecedor');
                    await carregarDadosIniciaisDoBanco(); 
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (error) {
                alert('Erro de comunica√ß√£o com o servidor ao salvar.');
            }
        }
        
        async function excluirFornecedor(id) {
            if(confirm('Tem certeza que deseja excluir este fornecedor? \nEsta a√ß√£o N√ÉO pode ser desfeita.')) {
                try {
                    const response = await fetch(`fornecedores.php?id=${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    
                    alert(result.message);
                    
                    if (result.success) {
                        await carregarDadosIniciaisDoBanco();
                    }
                } catch (error) {
                    alert('Erro de comunica√ß√£o ao excluir fornecedor.');
                }
            }
        }

        function carregarProdutos() {
            const tbody = document.querySelector('#tabelaProdutos tbody');
            if (!tbody) return;

            tbody.innerHTML = '';
            carregarFornecedores();

            const produtosComNomes = state.produtos.map(p => {
                const fornecedor = state.fornecedores.find(f => f.id == p.fornecedor_id);
                return {
                    ...p,
                    fornecedor_nome: fornecedor ? fornecedor.razao_social : 'N/A'
                };
            });

            produtosComNomes.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.nome}</td>
                    <td>${p.material || '-'}</td>
                    <td>${p.fornecedor_nome}</td>
                    <td>${p.estoque_atual}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editarProduto(${p.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="excluirProduto(${p.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function handleSalvarProduto(e) {
            e.preventDefault();

            const payload = {
                id: document.getElementById('prodId').value,
                nome: document.getElementById('prodNome').value,
                descricao: document.getElementById('prodDescricao').value,
                material: document.getElementById('prodMaterial').value,
                tamanho: document.getElementById('prodTamanho').value,
                peso: document.getElementById('prodPeso').value,
                estoque_atual: parseInt(document.getElementById('prodEstoqueInicial').value) || 0 
            };

            try {
                const response = await fetch('produtos.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                alert(result.message);

                if (result.success) {
                    e.target.reset(); 
                    document.getElementById('prodId').value = ''; 
                    // Garante que o campo de estoque inicial seja limpo ap√≥s o cadastro
                    document.getElementById('prodEstoqueInicial').value = '0'; 
                    await carregarDadosIniciaisDoBanco(); 
                }
            } catch (error) {
                alert('Erro de comunica√ß√£o ao salvar o produto.');
            }
        }

        function editarProduto(id) {
            const produto = state.produtos.find(p => p.id == id);
            if (produto) {
                document.getElementById('prodId').value = produto.id;
                document.getElementById('prodNome').value = produto.nome;
                document.getElementById('prodDescricao').value = produto.descricao;
                document.getElementById('prodMaterial').value = produto.material;
                document.getElementById('prodTamanho').value = produto.tamanho;
                document.getElementById('prodPeso').value = produto.peso;
                document.getElementById('prodFornecedor').value = produto.fornecedor_id; 
                
                document.getElementById('prodNome').focus();
                window.scrollTo(0, document.getElementById('viewProdutos').offsetTop);
            }
        }

        async function excluirProduto(id) {
            if(confirm('Tem certeza que deseja excluir este produto?')) {
                try {
                    const response = await fetch(`produtos.php?id=${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    
                    alert(result.message);

                    if (result.success) {
                        await carregarDadosIniciaisDoBanco();
                    }
                } catch (error) {
                    alert('Erro de comunica√ß√£o ao excluir produto.');
                }
            }
        }

        function carregarTabelaPosicaoEstoque() {
            const tbody = document.querySelector('#tabelaPosicaoEstoque tbody');
            if (!tbody) return;
            tbody.innerHTML = '';
            
            atualizarStatsEstoque(); 

            const produtosComNomes = state.produtos.map(p => {
                const fornecedor = state.fornecedores.find(f => f.id == p.fornecedor_id);
                return {
                    ...p,
                    fornecedor_nome: fornecedor ? fornecedor.razao_social : 'N/A'
                };
            });

            produtosComNomes.forEach(p => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id}</td>
                    <td>${p.nome}</td>
                    <td>${p.fornecedor_nome}</td>
                    <td>${p.estoque_atual}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="abrirModalAjusteEstoque(${p.id})">Ajustar Qtd.</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function abrirModalAjusteEstoque(id) {
            const produto = state.produtos.find(p => p.id == id);
            if(produto) {
                document.getElementById('ajusteProdutoId').value = produto.id;
                document.getElementById('ajusteProdutoNome').value = produto.nome;
                document.getElementById('ajusteQtdAtual').value = produto.estoque_atual;
                document.getElementById('ajusteQtdNova').value = produto.estoque_atual;
                document.getElementById('ajusteObservacao').value = ''; 
                document.getElementById('modalAjusteEstoque').style.display = 'flex';
                document.getElementById('ajusteQtdNova').focus();
            }
        }

        async function handleAjusteEstoque(e) {
            e.preventDefault();
            
            const produtoId = parseInt(document.getElementById('ajusteProdutoId').value);
            const qtdAtual = parseInt(document.getElementById('ajusteQtdAtual').value);
            const qtdNova = parseInt(document.getElementById('ajusteQtdNova').value);
            const observacao = document.getElementById('ajusteObservacao').value;

            if (observacao.trim() === '') {
                alert('A observa√ß√£o √© obrigat√≥ria para realizar um ajuste de invent√°rio.');
                return;
            }

            const diferenca = qtdNova - qtdAtual;

            if (diferenca === 0) {
                alert('A nova quantidade √© a mesma que a atual.');
                return;
            }

            const payload = {
                produto_id: produtoId,
                tipo: diferenca > 0 ? 'entrada' : 'saida',
                quantidade: Math.abs(diferenca),
                data: new Date().toISOString(), 
                observacao: observacao
            };

            try {
                const response = await fetch('movimentacao.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if(result.success) {
                    alert(result.message);
                    fecharModal('modalAjusteEstoque');
                    await carregarDadosIniciaisDoBanco(); 
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (error) {
                alert('Erro de comunica√ß√£o ao ajustar estoque.');
            }
        }

        function carregarDropdownProdutos() {
            const select = document.getElementById('movProduto');
            if (!select) return;

            select.innerHTML = ''; 
            if (state.produtos.length === 0) {
                select.innerHTML = '<option value="">Nenhum produto cadastrado</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            state.produtos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.nome} (Estoque: ${p.estoque_atual})`;
                select.appendChild(option);
            });
        }

        async function handleNovaMovimentacao(e) {
            e.preventDefault();

            const payload = {
                produto_id: parseInt(document.getElementById('movProduto').value),
                tipo: document.getElementById('movTipo').value,
                quantidade: parseInt(document.getElementById('movQuantidade').value),
                observacao: document.getElementById('movObservacao').value,
                data: new Date().toISOString()
            };

            if (!payload.produto_id || !payload.quantidade || payload.quantidade <= 0) {
                alert('Por favor, selecione um produto e insira uma quantidade v√°lida.');
                return;
            }

            try {
                const response = await fetch('movimentacao.php', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                alert(result.message);

                if(result.success) {
                    e.target.reset(); 
                    await carregarDadosIniciaisDoBanco(); 
                }
            } catch (error) {
                alert('Erro de comunica√ß√£o ao registrar movimenta√ß√£o.');
            }
        }

        async function carregarHistorico() {
            try {
                const response = await fetch('movimentacao.php');
                const result = await response.json();

                if (result.success) {
                    state.movimentacoes = result.data;
                    renderizarTabelaHistorico();
                } else {
                    alert(result.message);
                    if (result.message.includes("Acesso negado")) handleLogout();
                }
            } catch (error) {
                alert('Erro ao carregar hist√≥rico.');
            }
            
            atualizarStatsEstoque();
        }

        function renderizarTabelaHistorico() {
            const tbody = document.querySelector('#tabelaHistorico tbody');
            if (!tbody) return; 

            const filtroProduto = document.getElementById('filtroProduto').value.toLowerCase();
            const filtroData = document.getElementById('filtroData').value; 
            const filtroTipo = document.getElementById('filtroTipo').value; 

            let movimentacoesFiltradas = state.movimentacoes.filter(mov => {
                const produtoNome = (mov.produto_nome || 'Produto exclu√≠do').toLowerCase();
                const dataMov = (mov.data_movimentacao || '1970-01-01 00:00:01').split(' ')[0]; 
                
                const matchProduto = produtoNome.includes(filtroProduto);
                const matchTipo = (filtroTipo === '') || (mov.tipo_movimentacao === filtroTipo);
                const matchData = (filtroData === '') || (dataMov === filtroData);
                
                return matchProduto && matchTipo && matchData;
            });

            tbody.innerHTML = '';
            movimentacoesFiltradas.forEach(mov => {
                const tr = document.createElement('tr');
                
                // **** CORRE√á√ÉO DA DATA/HORA ****
                const dataFormatada = new Date(mov.data_movimentacao).toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                // **** FIM DA CORRE√á√ÉO ****
                
                tr.innerHTML = `
                    <td>${dataFormatada}</td>
                    <td>${mov.produto_nome || 'Produto exclu√≠do'}</td>
                    <td style="color: ${mov.tipo_movimentacao === 'entrada' ? 'green' : 'red'}; font-weight: bold;">
                        ${mov.tipo_movimentacao.toUpperCase()}
                    </td>
                    <td>${mov.quantidade}</td>
                    <td>${mov.observacao || '-'}</td>
                `;
                tbody.appendChild(tr);
            });

            const pSemResultados = document.getElementById('semResultadosHistorico');
            pSemResultados.classList.toggle('hidden', movimentacoesFiltradas.length > 0);
        }

        function limparFiltrosHistorico() {
            document.getElementById('filtroProduto').value = '';
            document.getElementById('filtroData').value = '';
            document.getElementById('filtroTipo').value = '';
            renderizarTabelaHistorico();
        }

        // **** FUN√á√ÉO ADICIONADA ****
        async function excluirHistoricoCompleto() {
            const confirmacao = 'Tem certeza que deseja excluir TODO o hist√≥rico de movimenta√ß√µes?\n\nATEN√á√ÉO: Esta a√ß√£o √© irrevers√≠vel e apagar√° todos os registros do banco de dados para este fornecedor.';
            
            if (!confirm(confirmacao)) {
                return; // Usu√°rio cancelou
            }

            try {
                // Envia uma requisi√ß√£o DELETE para o endpoint de movimenta√ß√£o.
                // O backend (movimentacao.php) deve ser programado para entender
                // que um m√©todo DELETE sem ID significa "excluir tudo do usu√°rio logado".
                const response = await fetch('movimentacao.php', {
                    method: 'DELETE'
                });

                const result = await response.json();

                alert(result.message); 

                if (result.success) {
                    // Atualiza a interface (frontend) para refletir a exclus√£o
                    state.movimentacoes = [];        // Limpa o array de movimenta√ß√µes
                    renderizarTabelaHistorico();   // Renderiza a tabela (agora vazia)
                    atualizarStatsEstoque();       // Atualiza os cards (para 0)
                }
            } catch (error) {
                console.error("Erro ao excluir hist√≥rico:", error);
                alert('Erro de comunica√ß√£o com o servidor ao tentar excluir o hist√≥rico.');
            }
        }
        // **** FIM DA FUN√á√ÉO ADICIONADA ****

        function atualizarStatsEstoque() {
            // Esta verifica√ß√£o evita chamar 'carregarHistorico' se os dados j√° est√£o l√°
            if (state.movimentacoes.length === 0 && state.loggedInUser && document.getElementById('viewEstoque').classList.contains('active')) {
                carregarHistorico(); 
            }
            
            const totalProdutosEl = document.getElementById('totalProdutos');
            if(totalProdutosEl) totalProdutosEl.textContent = state.produtos.length;
            
            const hoje = new Date().toISOString().slice(0, 10); 
            const movsHoje = state.movimentacoes.filter(m => (m.data_movimentacao || '').startsWith(hoje));

            const entradasEl = document.getElementById('entradasHoje');
            const saidasEl = document.getElementById('saidasHoje');

            if(entradasEl) entradasEl.textContent = movsHoje
                .filter(m => m.tipo_movimentacao === 'entrada')
                .reduce((sum, m) => sum + parseInt(m.quantidade), 0);
            
            if(saidasEl) saidasEl.textContent = movsHoje
                .filter(m => m.tipo_movimentacao === 'saida')
                .reduce((sum, m) => sum + parseInt(m.quantidade), 0);
        }

        // ---- FUN√á√ïES UTILIT√ÅRIAS ----
        
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            if (!alert) return;
            alert.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alert.textContent = message;
            alert.classList.remove('hidden');
            setTimeout(() => alert.classList.add('hidden'), 4000);
        }

        function mascaraCPF(v) {
            v = v.replace(/\D/g, '');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d)/, '$1.$2');
            v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            return v;
        }

        function mascaraCNPJ(v) {
            v = v.replace(/\D/g, '');
            v = v.replace(/^(\d{2})(\d)/, '$1.$2');
            v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
            v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
            v = v.replace(/(\d{4})(\d)/, '$1-$2');
            return v;
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

    </script>
</body>
</html>